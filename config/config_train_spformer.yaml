# DINOSAUR 3D训练配置 (SPFormer特征输入, 384维)

# ==================== 模型参数 ====================
model:
  # 特征维度
  din_feature_dim: 768          # DINOSAUR内部特征维度（保持768以匹配硬编码）
  spformer_dim: 32              # SPFormer输出维度
  num_points: 512               # 超点数量
  token_num: 512                # Token数量（等于超点数）
  
  # Slot Attention
  num_slots: 16                 # Slot数量（过分割配置）
  slot_dim: 256                 # Slot特征维度
  slot_att_iter: 3              # Slot Attention迭代次数
  query_opt: True               # 使用可学习的Slot初始化
  ISA: True                     # 使用ISA（3D位置编码）
  
  # 特征投影层配置
  projector:
    type: sequential
    layers:
      - type: linear
        in_dim: 32
        out_dim: 256
      - type: layernorm
        dim: 256
      - type: relu
      - type: dropout
        p: 0.1
      - type: linear
        in_dim: 256
        out_dim: 768
      - type: layernorm
        dim: 768

# ==================== 训练超参数 ====================
train:
  # 优化器
  optimizer:
    type: AdamW
    lr: 2.0e-4                  # 学习率
    weight_decay: 0.05
    betas: [0.9, 0.999]
    eps: 1.0e-8
  
  # 学习率调度器
  scheduler:
    type: PolyLR
    power: 0.9
    constant_ending: 0.0
    min_lr: 1.0e-6
  
  # 批次配置
  batch_size_per_gpu: 8        # 单卡batch size（双4090总batch=20）
  accumulation_steps: 1         # 梯度累积步数
  num_workers: 8                # 数据加载进程数
  pin_memory: True
  
  # 训练轮次
  epochs: 120
  warmup_epochs: 8
  
  # 梯度相关
  grad_clip_norm: 0.5           # 降低梯度裁剪阈值增强稳定性
  use_amp: True                 # 混合精度训练
  
  # 冻结策略
  freeze_spformer: True         # 是否冻结SPFormer
  unfreeze_after_epoch: 40      # 多少epoch后解冻（可选微调）

# ==================== 损失函数 ====================
loss:
  weights:
    reconstruction: 1.0         # w1: MSE重建损失权重
    mask_entropy: 0.4          # w2: Mask熵正则（鼓励确定性分配）
    slot_diversity: 0.4        # w3: Slot多样性损失（防止坍缩）
    mask_uniformity: 0.5       # w4: Mask均匀性损失（防止所有点塌缩到单个slot）

# ==================== 数据增强 ====================
augmentation:
  rotation_range: [-8, 8]       # 随机旋转范围（度）
  scale_range: [0.9, 1.1]       # 随机缩放范围
  translation: 0.08             # 随机平移（归一化空间）
  point_dropout: 0.1            # 超点随机dropout概率
  jitter_sigma: 0.01            # 坐标抖动标准差

# ==================== 分布式训练 ====================
distributed:
  backend: nccl                 # 分布式后端
  find_unused_parameters: False
  gradient_as_bucket_view: True
  sync_bn: True                 # 同步BatchNorm

# ==================== Checkpoint & 验证 ====================
checkpoint:
  save_interval: 5              # 保存间隔（epochs）
  keep_top_k: 3                 # 保留最佳k个模型
  save_optimizer: True          # 是否保存优化器状态
  output_dir: ./checkpoints_spformer

validation:
  val_interval: 3               # 验证间隔（每N个epoch进行一次验证，记录所有损失项）
  early_stopping_patience: 25   # 早停patience（基于验证总损失）

# ==================== 可视化配置 ====================
visualization:
  save_html: True               # 是否生成交互式HTML
  html_point_size: 2.0          # HTML中原始点云的点大小
  html_slot_point_size: 4.0     # HTML中slot点大小

# ==================== 数据路径 ====================
data:
  spformer_config: ../SPFormer/configs/spf_scannet.yaml
  spformer_checkpoint: /home/pbw/data1/3D_PointCloud_Segmentation/PLSG_Net/Model_Code/Model/spf_scannet_512.pth      # SPFormer预训练权重
  s3dis_root: /home/pbw/data1/3D_PointCloud_Segmentation/PLSG_Net/dataset/S3DIS/Stanford_Large-Scale_Indoor_Spaces_3D_Dataset/Stanford3dDataset_v1.2_Aligned_Version
  train_areas: [1, 2, 3, 4, 6]  # 训练集区域
  val_areas: [5]                # 验证集区域
  test_areas: [5]               # 测试集区域
  n_superpoints: 512            # 超点数量（需与num_points一致）

# ==================== 其他 ====================
seed: 1999
device: cuda
gpu_ids: [0]
log_interval: 10                # 日志打印间隔（iterations）
vis_interval: 500               # 可视化间隔（iterations）
ignore_sklearn_warnings: True   # 是否忽略sklearn聚类警告

